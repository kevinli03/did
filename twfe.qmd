# twfe (fixest) {.unnumbered}

::: small
non-staggered, absorbing, binary treatment
:::

The two-way fixed effects (TWFE) estimator is the standard estimator used for DiD. The model takes the following form.

$$
Y_{it} = \underbrace{\hat\alpha_i + \hat\delta_t}_\text{fixed effects} + D_{it}\hat\tau  + \mathbf X_{it}^\top\hat{\b\beta} + \hat\eps_{it}
$$

The idea is that unit fixed effects $\alpha_i$ account for between-unit differences, and time fixed effects $\delta_t$ account for between-period differences. Thus, the only remaining confounders are varying-trends, which are assumed to not be present due to the parallel trends assumption.

The TWFE $\hat\tau$ estimate is an unbiased esitmator of the ATT if treatment is non-staggered and absorbing, and the identification assumptions hold.

::: small
TWFE can be severely biased if there is staggered treatment or non-absorbing treatment. Details are further explained [here](bacom.qmd).
:::

```{r}
#| message: false
#| warning: false

# packages needed: 
library(fixest)
library(ggfixest)
```

<br />

```{r}
#| echo: false
#| warning: false
#| message: false

library(fixest)
data(base_stagg, package = "fixest")
df <- base_stagg
colnames(df) <- c("id", "time", "cohort", "rel.time", "group", "te", "covar", "outcome")
df$treat <- ifelse(df$rel.time >= 0, 1, 0)
```

::: panel-tabset
## Syntax

We use the `feols()` function to run the TWFE model.

```{r}
#| message: false
#| warning: false
#| comment: "#>"
#| class-output: r

mod = feols(
  fml   = outcome ~ treat + covar | id + time,  # covariate is optional
  data  = df,                                   # your data
  vcov  = ~ id                                  # cluster SE by unit
)

mod |> summary()
```

The coefficient of `treat` is our estimate of the ATT - the causal effect of treatment on those who receive the treatment. The significance is given by `Pr(>|t|)` (the p-value) and the stars `***` .

## Variables

Our dataset `df` should be a panel or repeated cross-section, and have the following variables:

| Variable  | Description                                                                                          |
|-------------------|-----------------------------------------------------|
| `id`      | A variable indicating the units/individual an observation belongs to in our data.\*                  |
| `time`    | A variable indicating time-periods in our study for each observation.                                |
| `outcome` | Outcome variable for each observation.                                                               |
| `treat`   | Treatment variable for each observation. Should equal 1 for treated units and 0 for untreated units. |
| `covar`   | (optional) covariate(s) to condition for parallel trends.                                            |

::: small
\*For repeated cross-section, the `id` variable should be instead the group/level of which treatment is assigned. For example, if treatment is assigned by county/state, use that as the `id` variable.
:::
:::

<br />

We can also estimate event-study dynamic effects for pre and post-treatment periods.

::: panel-tabset
## Syntax

We use the `feols()` function to run the TWFE event study.

```{r}
#| message: false
#| warning: false
#| comment: "#>"
#| class-output: r

mod = feols(
  fml   = outcome ~ i(rel.time, group, ref = -1) + covar | id + time,  # group = treat/never-treat
  data  = df,                                                          # your data
  vcov  = ~ id                                                         # cluster SE by unit
)
```

We can plot these results. The `ggiplot()` function produces a ggplot2 figure, so any ggplot2 options can be added with a `+`, including themes, labels, etc.

```{r}
#| message: false
#| warning: false
#| fig-height: 3
#| fig-align: center

mod |> ggiplot(
  xlab    = "Time Relative to Treatment",  # x-axis label
  ylab    = "Dynamic ATT Estimate",        # y-axis label
  main    = "Dynamic Treatment Effects",   # title for plot
) +
  xlim(-8, 8) # select how many periods to display
```

## Variables

Our dataset `df` should be a panel or repeated cross-section, and have the following variables:

| Variable   | Description                                                                                                                                                                                                                                                            |
|--------------------|----------------------------------------------------|
| `id`       | A variable indicating the units/individual an observation belongs to in our data.\*                                                                                                                                                                                    |
| `time`     | A variable indicating time-periods in our study for each observation.                                                                                                                                                                                                  |
| `outcome`  | Outcome variable for each observation.                                                                                                                                                                                                                                 |
| `group`    | Variable specifying if a unit is part of the treatment group or never-treated (control group). For units never receiving treatment, they get value 0, and for units that do end up receiving treatment sometime within the study, they get value 1.                    |
| `rel.time` | A relative time variable that indicates for the given period $t$ of an observation, how many time-periods away did the unit $i$ first get the treatment. For the never-treated observations, set the value to a very large or small number (-1000 is a common choice). |
| `covar`    | (optional) covariate(s) to condition for parallel trends.                                                                                                                                                                                                              |

::: small
\*For repeated cross-section, the `id` variable should be instead the group/level of which treatment is assigned. For example, if treatment is assigned by county/state, use that as the `id` variable.
:::
:::

<br />
