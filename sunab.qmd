# sunab (fixest) {.unnumbered}

::: small
staggered, absorbing, binary treatment
:::

The **interaction-weighted** (IW) estimator, also called **sunab**, is used for DiD with staggered treatment. The estimator solves the bias of TWFE in staggered settings.

The estimator essentially runs smaller event study DiDs for each different initial treatment period grouping. This is done by interactions in the TWFE model.

$$
Y_{it} = \alpha_i + \delta_t + \underbrace{\sum_g \sum_{r â‰  -1} 1\{G_i = g\} \cdot 1\{R_{it} = r\} \cdot \tau_{gr}}_\text{comparisons for each group g and rel.time r} + \cov + \eps_{it}
$$

::: small
$G_i$ is a categorical variable that describes which initial treatment period unit $i$ received treatment. $R_{it}$ is a relative-time variable. Essentially, IW is estimating dynamic treatment effects for each initial treatment period group $g$.
:::

Then, these individual event-study estimates $\tau_{g, r}$ for each group are aggregated to obtain an overall ATT or dynamic ATTs.

```{r}
#| message: false
#| warning: false

# packages needed:
library(fixest)
library(ggfixest)
```

<br />

```{r}
#| echo: false
#| warning: false
#| message: false

library(fixest)
data(base_stagg, package = "fixest")
df <- base_stagg
colnames(df) <- c("id", "time", "cohort", "rel.time", "group", "te", "covar", "outcome")
df$treat <- ifelse(df$rel.time >= 0, 1, 0)
```

::: panel-tabset
## Syntax

We use the `feols()` function and the `sunab()` function to run the matching process of sunab:

```{r}
#| message: false

mod = feols(
  fml = outcome ~ sunab(cohort, time) + covar | id + time,
  data = df,
  vcov = ~ id
)
```

This completes the matching process. We then need to aggregate to obtain the treatment effects.

## Variables

Our dataset `df` should be a panel or repeated cross-section, and have the following variables:

| Variable  | Description                                                                                                                                                                                                           |
|-----------|-----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|
| `id`      | A variable indicating the units/individual an observation belongs to in our data.\*                                                                                                                                   |
| `time`    | A variable indicating time-periods in our study for each observation.                                                                                                                                                 |
| `outcome` | Outcome variable for each observation.                                                                                                                                                                                |
| `covar`   | (optional) covariate(s) to condition for parallel trends.                                                                                                                                                             |
| `cohort`  | This variable indicates the initial year of treatment adoption for each unit. For the never-treated, we should set the value of `cohort` to a very large positive/negative value that is outside the range of `time`. |

::: small
\*For repeated cross-section, the `id` variable should be instead the group/level of which treatment is assigned. For example, if treatment is assigned by county/state, use that as the `id` variable.
:::

## Notes

The variable `cohort` should be of the following:

1.  Units that get treated at any time period, should have a `cohort` value of that initial treatment period.
2.  Units that never get treated at any time, should have a very large/small `cohort` value that is not one of the `time` fixed effects.

Ensure that `cohort` is **not** equal to `NA` for the never-treated (control) group. This will cause inaccurate estimation.
:::

<br />

After completing the matching process, we can aggregate our effects into an overall ATT, dynamic ATTs, and cohort-ATTs.

::: panel-tabset
## ATT

We use the `aggregate()` function to aggregate our matched treatment effects into an overall treatment effect.

```{r}
#| comment: "#>"
#| class-output: r

mod |>
  aggregate(agg  = "att") |>
  print()
```

We can see the estimated ATT in the output table, as well as the estimated p-value in `Pr(>|t|)`.

## Dynamic

We can plot the dynamic treatment effects using the IW object estimated when running the model:

```{r}
#| message: false
#| warning: false
#| fig-height: 3
#| fig-align: center

mod |> ggiplot(
  xlab    = "Time Relative to Treatment",       # x-axis label
  ylab    = "Dynamic ATT Estimate",             # y-axis label
  main    = "Dynamic Treatment Effects (IW)",   # title for plot
) + 
  xlim(-8, 8) # how many periods to include.
```

## Group

If we are interested in how the ATT differs by year of treatment adoption, we can also aggregate effects by initial treatment period group.

```{r}
#| comment: "#>"
#| class-output: r

group = mod |>
  aggregate(agg = "cohort")
```

There isn't a quick way to immediately plot these estimates, but we can manually create a ggplot:

```{r}
#| fig-height: 3.5
#| warning: false
#| fig-align: center

# make group a df
group = group |> as.data.frame()

# add cohort period to group df
group$period = group |> rownames()
group$period = group$period |> as.factor()

# calculate lower and upper conf intervals
group$lower = group$Estimate - 1.96*group$`Std. Error`
group$upper = group$Estimate + 1.96*group$`Std. Error`

# ggplot
group |>
  ggplot(aes(x = Estimate, y = period)) +
  geom_vline(xintercept = 0, color = "red", linetype = 3) +  # vertical line at 0 treatment effect
  geom_point() +  # plot the treatment effects
  geom_linerange(aes(xmin = lower, xmax = upper), width = 0.2) +  # conf intervals
  labs(title = "Treatment Effects by Initial Treatment Period") +  # title (optional)
  xlab("Estimated ATT (IW)") + ylab("Initial Treatment Period") +  # x-axis and y-axis labels (optional)
  theme_bw() # theme (optional, change to your liking)
```
:::

<br />

**Additional Resources**

Sun, L. and Abraham S. (2021) 'Estimating Dynamic Treatment Effects in Event studies with Heterogenous Treatment Effects', *Journal of Econometrics*, 225(2), pp. 175-199. Available at: <https://arxiv.org/abs/1804.05785>

Additional Links:

-   Fixest documentation for [sunab() function](https://lrberge.github.io/fixest/reference/sunab.html).
-   Fixest documentation for [aggregate() function](https://lrberge.github.io/fixest/reference/aggregate.fixest.html).
-   Asjad Naqvi [page on sunab](https://asjadnaqvi.github.io/DiD/docs/code_r/07_sunab_r/).
