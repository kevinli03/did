# bacondecomp {.unnumbered}

::: small
\(R\) understanding bias of TWFE in staggered settings
:::

When the [TWFE estimator](twfe.qmd) is used in staggered DiD, the estimated $\hat\tau_\text{TWFE}$ of the TWFE estimator can be biased. We can show this by decomposing $\hat\tau_\text{TWFE}$ in staggered settings, which reveals that $\hat\tau_\text{TWFE}$ is a weighted average of different comparisons $\hat\beta$. Two issues arise:

1.  Some of these comparisons are forbidden. For example, some of these $\hat\beta$ are calculated with already-treated units being the control group.
2.  The weighting of these $\hat\beta$ is non-sensical. For the ATT, they should be weighted by the frequency of that comparison. But TWFE weights are a combination of frequency and variance, and can even be negative.

The result? TWFE can be incorrect in staggered settings. Sometimes, TWFE may even get the wrong direction of treatment effect.

::: panel-tabset
## R

We will need the `bacondecomp` package. Documentation can be found [here](https://github.com/evanjflack/bacondecomp).

If you have not previously installed the package, you can do so as follows:

```{r}
#| eval: false

install.packages('bacondecomp')
```

Always remember to load the package before starting.

```{r}
#| message: false
#| warning: false

library(bacondecomp)
```
:::

```{r}
#| echo: false
#| warning: false
#| message: false

library(fixest)
data(base_stagg, package = "fixest")
df <- base_stagg
colnames(df) <- c("id", "time", "cohort", "rel.time", "group", "te", "covar", "outcome")
df$treat <- ifelse(df$rel.time >= 0, 1, 0)
```

We start by breaking down the TWFE into its comparisions $\hat\beta$ with bacon decomposition.

::: panel-tabset
## R

We use the `bacon()` function to implement decomposition of TWFE:

```{r}
#| message: false
#| warning: false
#| comment: "#>"
#| class-output: r
#| fig-height: 4
#| fig-align: center
#| results: hold

decomp = bacon(
  formula   = outcome ~ treat,
  data      = df,
  id_var    = "id",
  time_var  = "time"
)

decomp |> head()  # head() because a lot of comparisons
```

We can see the top output is a summary of the general comparisons, while the bottom output is the top 6 rows of all the individual $\hat\beta$ comparisons.

We can also see Later vs. Earlier (already) treated is a comparison here, which is nonsensical.

## Variables

Our dataset `df` should be a panel or repeated cross-section, and have the following variables:

| Variable  | Description                                                                                          |
|------------------|------------------------------------------------------|
| `id`      | A variable indicating the units/individual an observation belongs to in our data.\*                  |
| `time`    | A variable indicating time-periods in our study for each observation.                                |
| `outcome` | Outcome variable for each observation.                                                               |
| `treat`   | Treatment variable for each observation. Should equal 1 for treated units and 0 for untreated units. |
:::

We can plot the estimates and weights of all the comparisons to better understand what each comparison's value is, and how they are weighted.

```{r}
#| message: false
#| warning: false
#| comment: "#>"
#| class-output: r
#| fig-height: 4
#| fig-align: center

library(ggplot2)

decomp |>
  ggplot(aes(x = weight, y = estimate, shape = type, col = type)) +
  geom_point() +
  theme_bw() +
  labs(
    x      = "Weights",
    y      = "Estimates",
    shape  = "Type",
    col    = "Type",
    title  = "Decomposition of TWFE"
  )
```

The green highlighted comparisons all involve earlier (already) treated units being used as control units, which is nonsensical. Bacon decomposition thus shows us the perils of relying on TWFE for staggered treatment.

We know that any negative weights of any comparisons $\hat\beta$ are non-sensical. The graph also allows us to check this. In this example, there are no negative weights.

<br />

**Additional Resources**

Goodman-Bacon, A. (2021) 'Difference-in-Differences with variation in treatment timing', *Journal of Econometrics*, 225(2), pp. 254-277. Available at: <https://www.nber.org/papers/w25018>
